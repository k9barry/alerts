services:
  alerts:
    build: .
    container_name: alerts
    env_file:
      - .env
    environment:
      - DB_PATH=/data/alerts.sqlite
    volumes:
      - ./data:/data
      - ./logs:/logs
    labels:
      - traefik.enable=true
      - traefik.http.routers.alerts.entrypoints=websecure
      - traefik.http.routers.alerts.rule=Host(`noaa.jafcp.com`)
      - traefik.http.routers.alerts.middlewares=simpleAuth
      # Basic auth credentials (hashed APR1, not plaintext) - configured to match existing infrastructure
      # For production deployments with different credentials, generate new: htpasswd -nb username password | sed 's/\$/\$\$/g'
      - traefik.http.middlewares.simpleAuth.basicauth.users=k9barry:$$apr1$$Gvf0.vYy$$8WOCVhhCLhtIvz5wqktX20
      - traefik.http.services.alerts.loadbalancer.server.scheme=http
      - traefik.http.services.alerts.loadbalancer.server.port=8080
      - diun.enable=true
    networks:
      - traefik
    command: ["php", "-S", "0.0.0.0:8080", "-t", "public"]
    restart: unless-stopped

  sqlitebrowser:
    image: lscr.io/linuxserver/sqlitebrowser:latest
    container_name: sqlitebrowser
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      # Mount the full data directory read-only so the file can appear after container start
      - ./data:/config
    networks:
      - traefik
    restart: unless-stopped

  scheduler:
    build: .
    container_name: alerts_scheduler
    env_file:
      - .env
    environment:
      - DB_PATH=/data/alerts.sqlite
    volumes:
      - ./data:/data
      - ./logs:/logs
    labels:
      - diun.enable=true
    networks:
      - traefik
    depends_on:
      - alerts
    command: ["php", "scripts/scheduler.php"]
    restart: unless-stopped

networks:
  traefik:
    external: true
